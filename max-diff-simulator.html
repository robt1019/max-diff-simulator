<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulated Max Diff Stats</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

  <body>
    <h1>Comparison of Simulated Rates Across 4 Runs</h1>
    <div>
      <label for="sets">Number of Sets:</label>
      <input type="number" id="sets" value="7" min="1" />
      <label for="options">Number of Options:</label>
      <input type="number" id="options" value="9" min="1" />
      <label for="optionsPerSet">Options Per Set:</label>
      <input type="number" id="optionsPerSet" value="4" min="1" />
      <button onclick="updateCharts()">Update Charts</button>
    </div>
    <div id="chart1" style="width: 100%; height: 400px"></div>
    <div id="chart2" style="width: 100%; height: 400px"></div>
    <div id="chart3" style="width: 100%; height: 400px"></div>
    <div id="chart4" style="width: 100%; height: 400px"></div>

    <script>
      const numbers_of_respondents = [
        100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300,
        1400, 1500, 1600, 1700, 1800, 1900, 2000,
      ];

      function calculateChanceOfNotSeeingAtLeastOneOption(
        sets,
        options,
        optionsPerSet
      ) {
        const chance_of_miss = Math.pow(
          (options - optionsPerSet) / options,
          sets
        );
        return 1 - Math.pow(1 - chance_of_miss, options);
      }

      function simulateRates(chance_of_not_seeing_at_least_one_option) {
        const simulatedRates = [];
        for (const number_of_respondents of numbers_of_respondents) {
          let missed_at_least_one_option_count = 0;
          for (let i = 0; i < number_of_respondents; i++) {
            if (Math.random() < chance_of_not_seeing_at_least_one_option) {
              missed_at_least_one_option_count++;
            }
          }
          const simulatedRate =
            missed_at_least_one_option_count / number_of_respondents;
          simulatedRates.push(simulatedRate);
        }
        return simulatedRates;
      }

      function updateCharts() {
        const sets = parseInt(document.getElementById("sets").value);
        const options = parseInt(document.getElementById("options").value);
        const optionsPerSet = parseInt(
          document.getElementById("optionsPerSet").value
        );

        const chance_of_not_seeing_at_least_one_option =
          calculateChanceOfNotSeeingAtLeastOneOption(
            sets,
            options,
            optionsPerSet
          );

        console.log(
          `Sets: ${sets}, Options: ${options}, Options per set: ${optionsPerSet}`
        );
        console.log(
          `Chance of not seeing at least one option: ${chance_of_not_seeing_at_least_one_option.toFixed(
            4
          )}`
        );

        const charts = ["chart1", "chart2", "chart3", "chart4"];
        for (let run = 0; run < 4; run++) {
          const simulatedRates = simulateRates(
            chance_of_not_seeing_at_least_one_option
          );
          console.log(`Run ${run + 1}: Simulated rates:`, simulatedRates);

          const trace1 = {
            x: numbers_of_respondents,
            y: simulatedRates,
            mode: "lines+markers",
            name: "Simulated Rates",
            marker: { color: "blue" },
            line: { color: "blue" },
          };

          const trace2 = {
            x: numbers_of_respondents,
            y: Array(numbers_of_respondents.length).fill(
              chance_of_not_seeing_at_least_one_option
            ),
            mode: "lines",
            name: "Predicted Rate",
            line: { color: "green", dash: "dot" },
          };

          const layout = {
            title: `Run ${run + 1}`,
            xaxis: { title: "Number of Respondents" },
            yaxis: { title: "Rate of Not Seeing at Least One Option" },
            margin: { t: 50, b: 50, l: 50, r: 50 },
          };

          Plotly.newPlot(charts[run], [trace1, trace2], layout);
        }
      }

      // Initial chart rendering
      updateCharts();
    </script>
  </body>
</html>
